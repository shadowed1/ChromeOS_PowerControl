#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)
sleep 30
INSTALL_DIR="@INSTALL_DIR@"
CONFIG_FILE="/home/chronos/user/MyFiles/Downloads/ChromeOS_PowerControl_Config/config"
ZONE_PATH="/sys/class/thermal/thermal_zone0/temp"
RUN_FLAG="$INSTALL_DIR/.fancontrol_running"
PID_FILE="$INSTALL_DIR/.fancontrol_pid"
LOG_FILE="/var/log/fancontrol.log"
MONITOR_PID_FILE="$INSTALL_DIR/.fancontrol_monitor.pid"
timestamp=$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1)
CONF_SOURCE="$INSTALL_DIR/fancontrol.conf"
CONF_TARGET="/etc/init/fancontrol.conf"
wait_for_config() {
    local config_dir="/home/chronos/user/MyFiles/Downloads/ChromeOS_PowerControl_Config"
    local max_wait=300
    local elapsed=0
    
    while [ $elapsed -lt $max_wait ]; do
        if [ -f "$CONFIG_FILE" ]; then
            return 0
        fi
        
        sleep 5
        elapsed=$((elapsed + 5))
    done
    
    echo "${RED}Error: Config file not available after 5 minutes${RESET}" | tee -a "$LOG_FILE"
    return 1
}

if ! ( [[ -z "$1" ]] || [[ "$1" == "--h" || "$1" == "-h" || "$1" == "h" || "$1" == "--help" || "$1" == "-help" || "$1" == "monitor" || "$1" == "mon" || "$1" == "help" || "$1" == "status" ]] ) && [[ "$(id -u)" -ne 0 ]]; then    echo "${RED}FanControl requires sudo to run.${RESET}"
    echo "  Try: sudo fancontrol $*  or  sudo $0 $*"
    exit 1
fi

DEFAULT_FAN_MIN_TEMP=46
DEFAULT_FAN_MAX_TEMP=85
DEFAULT_MIN_FAN=0
DEFAULT_MAX_FAN=100  
DEFAULT_FAN_POLL=4
DEFAULT_STEP_UP=4
DEFAULT_STEP_DOWN=1

FAN_POLL=$DEFAULT_FAN_POLL
STEP_UP=$DEFAULT_STEP_UP
STEP_DOWN=$DEFAULT_STEP_DOWN
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE" 2>/dev/null
    fi
    validate_config
}

get_temp() {
    if [[ -r "$ZONE_PATH" ]]; then
        local raw_temp
        if read -r raw_temp < "$ZONE_PATH"; then
            if (( raw_temp >= 0 )); then
                echo $(( raw_temp / 1000 ))
                return 0
            else
                sleep 1
                continue
            fi
        else
            sleep 1
            continue
        fi
    else
        sleep 1
        continue
    fi
}



validate_config() {
    if [[ -z "$MAX_FAN" || ! "$MAX_FAN" =~ ^[0-9]+$ ]]; then
        MAX_FAN=$DEFAULT_MAX_FAN
    fi
    if [[ -z "$MIN_FAN" || ! "$MIN_FAN" =~ ^[0-9]+$ ]]; then
        MIN_FAN=$DEFAULT_MIN_FAN
    fi
    if (( MIN_FAN >= MAX_FAN )); then
        MIN_FAN=$DEFAULT_MIN_FAN
        MAX_FAN=$DEFAULT_MAX_FAN
    fi

    if [[ -z "$FAN_MAX_TEMP" || ! "$FAN_MAX_TEMP" =~ ^[0-9]+$ ]]; then
        FAN_MAX_TEMP=$DEFAULT_FAN_MAX_TEMP
    fi
    if [[ -z "$FAN_MIN_TEMP" || ! "$FAN_MIN_TEMP" =~ ^[0-9]+$ ]]; then
        FAN_MIN_TEMP=$DEFAULT_FAN_MIN_TEMP
    fi
    if (( FAN_MIN_TEMP >= FAN_MAX_TEMP )); then
        FAN_MIN_TEMP=$DEFAULT_FAN_MIN_TEMP
        FAN_MAX_TEMP=$DEFAULT_FAN_MAX_TEMP
    fi

    if [[ -z "$STEP_UP" || ! "$STEP_UP" =~ ^[0-9]+$ ]]; then
        STEP_UP=$DEFAULT_STEP_UP
    fi
    if [[ -z "$STEP_DOWN" || ! "$STEP_DOWN" =~ ^[0-9]+$ ]]; then
        STEP_DOWN=$DEFAULT_STEP_DOWN
    fi
    if [[ -z "$FAN_POLL" || ! "$FAN_POLL" =~ ^[0-9]+$ ]]; then
        FAN_POLL=$DEFAULT_FAN_POLL
    fi
}

save_config() {
    sed -i "s/^FAN_MAX_TEMP=.*/FAN_MAX_TEMP=$FAN_MAX_TEMP/" "$CONFIG_FILE" || echo "FAN_MAX_TEMP=$FAN_MAX_TEMP" >> "$CONFIG_FILE"
    sed -i "s/^FAN_MIN_TEMP=.*/FAN_MIN_TEMP=$FAN_MIN_TEMP/" "$CONFIG_FILE" || echo "FAN_MIN_TEMP=$FAN_MIN_TEMP" >> "$CONFIG_FILE"
    sed -i "s/^MAX_FAN=.*/MAX_FAN=$MAX_FAN/" "$CONFIG_FILE" || echo "MAX_FAN=$MAX_FAN" >> "$CONFIG_FILE"
    sed -i "s/^MIN_FAN=.*/MIN_FAN=$MIN_FAN/" "$CONFIG_FILE" || echo "MIN_FAN=$MIN_FAN" >> "$CONFIG_FILE"
    sed -i "s/^FAN_POLL=.*/FAN_POLL=$FAN_POLL/" "$CONFIG_FILE" || echo "FAN_POLL=$FAN_POLL" >> "$CONFIG_FILE"
    sed -i "s/^STEP_UP=.*/STEP_UP=$STEP_UP/" "$CONFIG_FILE" || echo "STEP_UP=$STEP_UP" >> "$CONFIG_FILE"
    sed -i "s/^STEP_DOWN=.*/STEP_DOWN=$STEP_DOWN/" "$CONFIG_FILE" || echo "STEP_DOWN=$STEP_DOWN" >> "$CONFIG_FILE"
}

cleanup() {
    echo "${YELLOW} $(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Restoring automatic fan control..." | tee -a "$LOG_FILE"
    sudo ectool autofanctrl 2>/dev/null
    echo "${RESET}"
    sudo rm -f "$RUN_FLAG" "$PID_FILE"
    exit 0
}

run_loop() {
wait_for_config
if read -r RAW_TEMP < "$ZONE_PATH"; then
    :
else
    echo "Failed to read temperature from $ZONE_PATH" >&2
    sleep 1
    continue
fi
    TEMP_C=$((RAW_TEMP / 1000))
    prev_temp=$TEMP_C

if (( TEMP_C <= FAN_MIN_TEMP )); then
    initial_duty=$MIN_FAN
elif (( TEMP_C >= FAN_MAX_TEMP )); then
    initial_duty=$MAX_FAN
else
    RANGE=$((FAN_MAX_TEMP - FAN_MIN_TEMP))
    OFFSET=$((TEMP_C - FAN_MIN_TEMP))
    initial_duty=$((MIN_FAN + (OFFSET * (MAX_FAN - MIN_FAN) / RANGE)))
fi

sudo ectool fanduty "$initial_duty"
    prev_temp=$TEMP_C
    local last_duty=-1
    local last_reload_time=0

    while [ -f "$RUN_FLAG" ]; do
        if [ ! -f "$ZONE_PATH" ]; then
            echo "${RED} $(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Thermal zone not found: $ZONE_PATH${RESET}" | tee -a "$LOG_FILE"
            cleanup
        fi

        now=$(date +%s)
        if (( now - last_reload_time >= 5 )); then
            load_config
            last_reload_time=$now
            if grep -q '^STARTUP_FANCONTROL=1' "$CONFIG_FILE"; then
                if [[ ! -f "$CONF_TARGET" ]]; then
                    sudo cp "$CONF_SOURCE" "$CONF_TARGET"
                    echo "${YELLOW}$(date '+%F %T') - FanControl Startup enabled${RESET}" >> "$LOG_FILE"
                fi
            else
                if [[ -f "$CONF_TARGET" ]]; then
                    sudo rm -f "$CONF_TARGET"
                    echo "${RED}$(date '+%F %T') - FanControl Startup disabled${RESET}" >> "$LOG_FILE"
                fi
            fi
        fi

        if read -r RAW_TEMP < "$ZONE_PATH"; then
            :
        else
            echo "Failed to read temperature from $ZONE_PATH" >&2
            sleep 1
            continue
        fi

        TEMP_C=$((RAW_TEMP / 1000))
        TEMP_C=$(((TEMP_C + prev_temp) / 2))
        prev_temp=$TEMP_C

        if (( TEMP_C <= FAN_MIN_TEMP )); then
            DUTY=$MIN_FAN
        elif (( TEMP_C >= FAN_MAX_TEMP )); then
            DUTY=$MAX_FAN
        else
            RANGE=$((FAN_MAX_TEMP - FAN_MIN_TEMP))
            OFFSET=$((TEMP_C - FAN_MIN_TEMP))
            DUTY=$((MIN_FAN + (OFFSET * (MAX_FAN - MIN_FAN) / RANGE)))
        fi

        HYSTERESIS=2
        effective_step_down=$STEP_DOWN
        (( effective_step_down < 1 )) && effective_step_down=1
        
        if (( last_duty < 0 )); then
            target_duty=$DUTY
        elif (( DUTY > last_duty + HYSTERESIS )); then
            diff=$((DUTY - last_duty))
            if (( diff > STEP_UP )); then
                target_duty=$((last_duty + STEP_UP))
            else
                target_duty=$DUTY
            fi
        elif (( DUTY < last_duty - HYSTERESIS )); then
            diff=$((last_duty - DUTY))
            if (( diff > effective_step_down )); then
                target_duty=$((last_duty - effective_step_down))
            else
                target_duty=$DUTY
            fi
        else
            target_duty=$last_duty
        fi

        need_kickstart=0
        if (( last_duty == 0 && target_duty > 0 )); then
            need_kickstart=1
        fi

        echo "${YELLOW}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) CPU: ${TEMP_C}°C -> Fan: ${target_duty}%${RESET}" >> "$LOG_FILE"

        if (( target_duty < MIN_FAN && TEMP_C <= FAN_MIN_TEMP )); then
            target_duty=0
        elif (( target_duty < MIN_FAN )); then
            target_duty=$MIN_FAN
        fi
        
        if (( need_kickstart == 1 && target_duty > 0 )); then
            echo "Applying kickstart ramp-up from 0% to ${target_duty}%" >> "$LOG_FILE"
            for duty in 4 8 12; do
                echo "  - Kickstart: ${duty}%" >> "$LOG_FILE"
                sudo ectool fanduty "$duty" | grep -v "Fan duty cycle set for all fans." >> "$LOG_FILE"
                sleep 0.5
            done
        fi
        
        if (( target_duty == 0 )); then
            if (( last_duty > 0 )); then
                echo "${YELLOW}Applying kickstart before stopping fan" >> "$LOG_FILE"
                for duty in 4 8 12; do
                    echo "  - Kickstart: ${duty}% ${RESET}" >> "$LOG_FILE"
                    sudo ectool fanduty "$duty" | grep -v "Fan duty cycle set for all fans." >> "$LOG_FILE"
                    sleep 0.5
                done
            fi
            sudo ectool fanduty 0 | grep -v "Fan duty cycle set for all fans." >> "$LOG_FILE"
        else
            sudo ectool fanduty "$target_duty" | grep -v "Fan duty cycle set for all fans." >> "$LOG_FILE"
        fi

        #if [[ -n "$prev_temp" ]]; then
        #    TEMP_C=$(((TEMP_C + prev_temp) / 2))
        #fi
        prev_temp=$TEMP_C

        if (( DUTY < MIN_FAN )); then
            DUTY=$MIN_FAN
        elif (( DUTY > MAX_FAN )); then
            DUTY=$MAX_FAN
        fi

        last_duty=$target_duty

        sleep "$FAN_POLL"
    done

    cleanup
}

start() {
    "$0" stop >/dev/null 2>&1

    FAN_COUNT=$(sudo ectool pwmgetnumfans | awk -F= '{print $2}' | sed -e 's/ //g')
    if [[ "$FAN_COUNT" =~ ^[0-9]+$ ]] && (( FAN_COUNT == 0 )); then
        echo ""
        echo "${RED}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - No fans detected (FAN_COUNT=0). Stopping.${RESET}" | tee -a "$LOG_FILE"
        echo ""
        exit 1
    fi

    LOG_FILE="/var/log/fancontrol.log"
    if [ -f "$LOG_FILE" ] && [ "$(stat -c%s "$LOG_FILE")" -gt 32768 ]; then
        echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Truncated log file (exceeded 32KB)" > "$LOG_FILE"
    fi

    if pgrep -f "[f]ancontrol __fancontrol_monitor__" >/dev/null; then
        echo ""
        echo "${YELLOW}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - FanControl already running.${RESET}" | tee -a "$LOG_FILE"
        echo ""
    else
        nohup "$0" __fancontrol_monitor__ >> "$LOG_FILE" 2>&1 &
        echo $! > "$MONITOR_PID_FILE"
        echo "${YELLOW}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Starting FanControl - Output is logged to $LOG_FILE${RESET}" | tee -a "$LOG_FILE"
    fi
}

stop() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            PGID=$(ps -o pgid= "$PID" | grep -o '[0-9]*')
            echo "${RED}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - FanControl Stopped (PGID $PGID)...${RESET}" | tee -a "$LOG_FILE"
            kill -- -"$PGID" 2>/dev/null
            sleep 1
        else
            echo "${YELLOW}FanControl process not found.${RESET}" | tee -a "$LOG_FILE"
        fi
        sudo rm -f "$PID_FILE"
    fi
    sudo rm -f "$RUN_FLAG"
    sudo ectool autofanctrl
}


monitor() {
    if [ -f "$MONITOR_PID_FILE" ]; then
        MONITOR_PID=$(cat "$MONITOR_PID_FILE")
        if ps -p "$MONITOR_PID" > /dev/null 2>&1; then
            echo "Stopping monitor (PID $MONITOR_PID)..."
            kill "$MONITOR_PID"
            sudo rm -f "$MONITOR_PID_FILE"
            exit 0
        else
            sudo rm -f "$MONITOR_PID_FILE"
        fi
    fi

    tail -fn +1 "$LOG_FILE" &
    echo $! > "$MONITOR_PID_FILE"
    echo "Monitor started (PID $!)"
}

fan_min_temp() {
    if [[ "$2" =~ ^[0-9]+$ ]]; then
        load_config
        FAN_MIN_TEMP=$2
        save_config
        echo "${YELLOW}"
        echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Min temp set to $FAN_MIN_TEMP°C" | tee -a "$LOG_FILE"
        echo "${RESET}"
    else
        echo "Usage: $0 fan_min_temp <number>"
    fi
}

fan_max_temp() {
    if [[ "$2" =~ ^[0-9]+$ ]] && (( $2 <= 90 )); then
        load_config
        FAN_MAX_TEMP=$2
        save_config
        echo "${YELLOW}"
        echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Max temp set to $FAN_MAX_TEMP°C" | tee -a "$LOG_FILE"
        echo "${RESET}"
    else
        echo "Usage: $0 fan_max_temp <number (<=90)>"
    fi
}

min_fan() {
    if [[ "$2" =~ ^[0-9]+$ ]] && (( $2 >= 0 && $2 <= 100 )); then
        load_config
        if (( MAX_FAN > $2 )); then
            MIN_FAN=$2
            save_config
            echo "${YELLOW}"
            echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Min fan set to $MIN_FAN%" | tee -a "$LOG_FILE"
            echo "${RESET}"
        else
            echo "Error: MIN_FAN must be less than MAX_FAN ($MAX_FAN)"
        fi
    else
        echo "Usage: $0 min_fan <0-100>"
    fi
}

max_fan() {
    if [[ "$2" =~ ^[0-9]+$ ]] && (( $2 >= 0 && $2 <= 100 )); then
        load_config
        if (( $2 > MIN_FAN )); then
            MAX_FAN=$2
            save_config
            echo "${YELLOW}"
            echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Max fan set to $MAX_FAN%" | tee -a "$LOG_FILE"
            echo ${RESET}
        else
            echo "Error: MAX_FAN must be greater than MIN_FAN ($MIN_FAN)"
        fi
    else
        echo "Usage: $0 max_fan <0-100>"
    fi
}

set_fan_poll() {
    if [[ "$2" =~ ^[0-9]+([.][0-9]+)?$ ]]; then
        FAN_POLL=$(printf "%.2f" "$2")
        if (( $(awk "BEGIN {print ($FAN_POLL < 1.0)}") )); then
            echo "${RED}Warning: FAN_POLL below 1.0s, resetting to 1.0s${RESET}"
            FAN_POLL=1.0
        elif (( $(awk "BEGIN {print ($FAN_POLL > 10.0)}") )); then
            echo "${RED}Warning: FAN_POLL above 10s, resetting to 10s${RESET}"
            FAN_POLL=10
        fi
        sed -i "s/^FAN_POLL=.*/FAN_POLL=$FAN_POLL/" "$CONFIG_FILE"
        echo ""
        echo "${YELLOW}FanControl polling rate set to $FAN_POLL seconds${RESET}"
        echo ""
    else
        echo "Error: FAN_POLL must be a number between 1.0 and 10.0 (e.g., 1.5, 3, 4.2)"
        exit 1
    fi
}

set_stepup() {
    if [[ "$2" =~ ^[0-9]+$ ]] && (( $2 >= 1 && $2 <= 100 )); then
        load_config
        STEP_UP=$2
        save_config
        echo "${YELLOW}"
        echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Step-up size set to $STEP_UP%" | tee -a "$LOG_FILE"
        echo "${RESET}"
    else
        echo "Usage: $0 step_up <step_size_percent (1-100)>"
    fi
}

set_stepdown() {
    if [[ "$2" =~ ^[0-9]+$ ]] && (( $2 >= 1 && $2 <= 100 )); then
        load_config
        STEP_DOWN=$2
        save_config
        echo "${YELLOW}"
        echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Step-down size set to $STEP_DOWN%" | tee -a "$LOG_FILE"
        echo "${RESET}"
    else
        echo "Usage: $0 step_down <step_size_percent (1-100)>"
    fi
}
show_help() {
echo "${YELLOW}"
echo "╔════════════════════════════════════════════════════════════════════════════════╗"
echo "║                                                                                ║"
echo "║                       FanControl commands with examples:                       ║"
echo "║                                                                                ║"
echo "║  fancontrol                   # Show FanControl status                         ║"
echo "║  fancontrol help              # Help menu                                      ║"
echo "║  fancontrol monitor           # Toggle on/off live monitoring in terminal      ║"
echo "║  sudo fancontrol start        # Start FanControl                               ║"
echo "║  sudo fancontrol stop         # Stop FanControl                                ║"
echo "║  sudo fancontrol min_temp 48  # Min temp threshold                             ║"
echo "║  sudo fancontrol max_temp 81  # Max temp threshold - Limit is 90°C             ║"
echo "║  sudo fancontrol min 0        # Min fan speed %                                ║"
echo "║  sudo fancontrol max 100      # Max fan speed %                                ║"
echo "║  sudo fancontrol step_up 20   # Fan step-up %                                  ║"
echo "║  sudo fancontrol step_down 1  # Fan step-down %                                ║"
echo "║  sudo fancontrol poll 2       # FanControl polling rate in seconds (1 to 10s)  ║"
echo "║  sudo fancontrol startup      # Copy or Remove fancontrol.conf at: /etc/init/  ║"
echo "║                                                                                ║"
echo "╚════════════════════════════════════════════════════════════════════════════════╝"
echo "${RESET}"
}

case "$1" in
    start) start ;;
    stop) stop ;;
    monitor|mon) tail -f /var/log/fancontrol.log ;;
    fan_min_temp|min_temp) fan_min_temp "$@" ;;
    fan_max_temp|max_temp) fan_max_temp "$@" ;;
    min_fan|min)  min_fan "$@" ;;
    max_fan|max)  max_fan "$@" ;;
    poll | fan_poll)   set_fan_poll "$@" ;;
    step_up)   set_stepup "$@" ;;
    step_down) set_stepdown "$@" ;;
    startup)
        CONF_SOURCE="$INSTALL_DIR/fancontrol.conf"
        CONF_TARGET="/etc/init/fancontrol.conf"

        read -p "Do you want FanControl to startup automatically? (y/n): " choice
    if [[ "$choice" =~ ^[Yy]$ ]]; then
        if [ -f "$CONF_SOURCE" ]; then
            echo "Copying fancontrol.conf to /etc/init/..."
            sudo cp "$CONF_SOURCE" "$CONF_TARGET"
            echo "${YELLOW}fancontrol.conf copied.${RESET}"
        else
            echo "${RED}fancontrol.conf not found at $CONF_SOURCE${RESET}"
        fi
    else
        echo "FanControl will not startup automatically."
        sudo rm -r /etc/init/fancontrol.conf 2>/dev/null
    fi
        ;;
    __fancontrol_monitor__)
        echo $$ > "$PID_FILE"
        touch "$RUN_FLAG"
        FAN_COUNT=$(sudo ectool pwmgetnumfans | awk -F= '{print $2}' | sed -e 's/ //g')
            if [[ "$FAN_COUNT" =~ ^[0-9]+$ ]] && (( FAN_COUNT == 0 )); then
                echo "${RED}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - No fans detected (FAN_COUNT=0). Stopping monitor.${RESET}" | tee -a "$LOG_FILE"
                sudo rm -f "$RUN_FLAG" "$PID_FILE"
                exit 1
            fi
        run_loop
        ;;
    ""|status)
        load_config
        if [ -f "$RUN_FLAG" ]; then
            PID=$(cat "$PID_FILE")
            if ps -p "$PID" > /dev/null 2>&1; then
echo "${YELLOW}"
echo "══════════════════════════════════════════════════════════"
echo "         FanControl Status: RUNNING (PID $PID)"
            else
echo "${RED}"
echo "══════════════════════════════════════════════════════════"
echo "  FanControl Status: RUN FLAG PRESENT, but not running   "
            fi
        else
            echo
echo "${RED}"
echo "══════════════════════════════════════════════════════════"
echo "                FanControl Status: STOPPED               "
        fi
echo ""
echo -n "  "; sudo ectool pwmgetnumfans 2>/dev/null
echo -n "  "; sudo ectool pwmgetfanrpm all 2>/dev/null
echo "  CPU temp: $(get_temp)°C"
echo "  Fan Curve: $FAN_MIN_TEMP°C = ${MIN_FAN}% RPM -> $FAN_MAX_TEMP°C = ${MAX_FAN}% RPM"
echo "  Polling rate: ${FAN_POLL}s"
echo "  Step-up: $STEP_UP%, Step-down: $STEP_DOWN%"
echo "══════════════════════════════════════════════════════════"
echo "${RESET}"
        ;;
    --h|-h|h|--help|-help|help) show_help ;;
    *) echo "Unknown command: $1"; show_help ;;
esac

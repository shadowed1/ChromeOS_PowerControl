#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)
INSTALL_DIR="@INSTALL_DIR@"
CONFIG_FILE="/home/chronos/user/MyFiles/Downloads/ChromeOS_PowerControl_Config/config"
BATTERY_PATH=""
STATUS_PATH=""
RUN_FLAG="$INSTALL_DIR/.batterycontrol_enabled"
PID_FILE="$INSTALL_DIR/.batterycontrol_pid"
LOG_FILE="/var/log/batterycontrol.log"
timestamp=$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1)
CONF_SOURCE="$INSTALL_DIR/batterycontrol.conf"
CONF_TARGET="/etc/init/batterycontrol.conf"

if ! ( [[ -z "$1" ]] || [[ "$1" == "--h" || "$1" == "-h" || "$1" == "h" || "$1" == "--help" || "$1" == "-help" || "$1" == "help" || "$1" == "monitor" || "$1" == "mon" || "$1" == "usage" || "$1" == "status" ]] ) && [[ "$(id -u)" -ne 0 ]]; then    
    echo "${RED}BatteryControl requires sudo to run.${RESET}"
    echo "  Try: sudo batterycontrol $*  or  sudo $0 $*"
    exit 1
fi

DEFAULT_CHARGE_MAX=77
CHARGE_MAX=

detect_battery() {
    for d in /sys/class/power_supply/*; do
        if [ -f "$d/capacity" ] && [ -f "$d/status" ]; then
            read -r status < "$d/status"
            if [ "$status" != "Unknown" ]; then
                BATTERY_PATH="$d/capacity"
                STATUS_PATH="$d/status"
                return 0
            fi
        fi
    done

    echo "${RED}No battery detected! ${RESET}"
    BATTERY_PATH=""
    STATUS_PATH=""
    continue
    sleep 1
}

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE" 2>/dev/null
    fi
    validate_config
}

validate_config() {
    if [[ -z "$CHARGE_MAX" || ! "$CHARGE_MAX" =~ ^[0-9]+$ ]]; then
        CHARGE_MAX=$DEFAULT_CHARGE_MAX
    fi
    if (( CHARGE_MAX > 100 )); then
        CHARGE_MAX=100
    elif (( CHARGE_MAX < 14 )); then
        CHARGE_MAX=14
    fi
}

save_config() {
    validate_config
    sed -i "s/^CHARGE_MAX=.*/CHARGE_MAX=$CHARGE_MAX/" "$CONFIG_FILE" || echo "CHARGE_MAX=$CHARGE_MAX" >> "$CONFIG_FILE"
}

load_config

set_threshold() {
    if ! [[ "$1" =~ ^[0-9]+$ ]]; then
        echo "Error: Threshold must be an integer."
        exit 1
    fi
    if (( $1 > 100 || $1 < 14 )); then
        echo "Error: CHARGE_MAX must be between 14 and 100."
        exit 1
    fi

    CHARGE_MAX=$1
    save_config
    echo "${GREEN}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Charge Limit: ${CHARGE_MAX}%${RESET}" | tee -a "$LOG_FILE"
}

load_config

show_help() {
echo "${GREEN}"
echo "╔════════════════════════════════════════════════════════════════════════════════════╗"
echo "║                                                                                    ║"
echo "║                       BatteryControl commands with examples:                       ║"
echo "║                                                                                    ║"
echo "║  batterycontrol               # Check BatteryControl status                        ║"
echo "║  batterycontrol help          # Help menu                                          ║"
echo "║  batterycontrol monitor       # Real-time batterycontrol log                       ║"
echo "║  sudo batterycontrol start    # Start BatteryControl                               ║"
echo "║  sudo batterycontrol stop     # Stop BatteryControl                                ║"
echo "║  sudo batterycontrol 77       # Charge limit set to 77% - Minimum allowed is 14%   ║"
echo "║  sudo batterycontrol startup  # Copy or Remove batterycontrol.conf at: /etc/init/  ║"
echo "║  sudo batterycontrol usage    # See power consumption in real-time!                ║"
echo "║                                                                                    ║"
echo "╚════════════════════════════════════════════════════════════════════════════════════╝"
echo "${RESET}"
}

detect_active_usbpd_port() {
    local port_output
    port_output=$(sudo ectool usbpdpower 2>/dev/null)
    local line port

    while IFS= read -r line; do
        if [[ "$line" =~ ^Port[[:space:]]+([0-9]+):[[:space:]]+SNK[[:space:]]+Charger ]]; then
            port="${BASH_REMATCH[1]}"
            echo "$port"
            return
        fi
    done <<< "$port_output"

    echo "-1"
}

battery_status() {
    detect_battery
    if [ -f "$RUN_FLAG" ]; then
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if ps -p "$PID" > /dev/null 2>&1; then
echo "${GREEN}"
echo "═════════════════════════════════════════════════════════════════════════════"
echo "                BatteryControl is: RUNNING (PID $PID)"
            else
echo "${RED}"
echo "═════════════════════════════════════════════════════════════════════════════"
echo "              BatteryControl is: RUNNING (but process is NOT)         "
                rm -f "$PID_FILE"
            fi
        else
echo "${RED}"
echo "═════════════════════════════════════════════════════════════════════════════"
echo "                   BatteryControl is: RUNNING (PID not found)                       "
        fi
else
echo "${RED}"
echo "═════════════════════════════════════════════════════════════════════════════"
echo "                       BatteryControl is: STOPPED"
    fi
echo ""
echo "Charge Limit: $CHARGE_MAX"
echo ""
        local active_port
        active_port=$(detect_active_usbpd_port)
        if [ "$active_port" != "-1" ]; then

echo "Active USB-PD Charger Port: $active_port (CROS_USBPD_CHARGER$active_port)"
sudo ectool usbpdpower 2>/dev/null || echo "Failed to run ectool usbpdpower (is ectool installed and available?)"
echo
sudo ectool battery 2>/dev/null || echo "Failed to run ectool battery (is ectool installed and available?)"
echo "  Capacity: $BATTERY_PATH"
echo "  State:   $STATUS_PATH"
echo "═════════════════════════════════════════════════════════════════════════════"
echo ""
        else
echo "Active USB-PD Charger Port: None detected "
sudo ectool usbpdpower 2>/dev/null || echo "Failed to run ectool usbpdpower (is ectool installed and available?)"
echo
sudo ectool battery 2>/dev/null || echo "Failed to run ectool battery (is ectool installed and available?)"
echo "  Capacity: $BATTERY_PATH"
echo "  State:   $STATUS_PATH"
echo "═════════════════════════════════════════════════════════════════════════════"
echo "${RESET}"

    fi
}

start_monitoring_loop() {
    detect_battery
    touch "$RUN_FLAG"
    echo $$ > "$PID_FILE"

    echo "${GREEN}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - BatteryControl started. (PID $$).${RESET}"

    local last_reload_time=0

    while true; do
        if [ ! -f "$RUN_FLAG" ]; then
            echo "${RED}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - BatteryControl Stopped${RESET}." | tee -a "$LOG_FILE"
            rm -f "$PID_FILE"
            exit 0
        fi

        now=$(date +%s)
        if (( now - last_reload_time >= 15 )); then
            load_config
            last_reload_time=$now

            if read -r BATTERY_CHARGE < "$BATTERY_PATH"; then
                read -r STATE < "$STATUS_PATH" || STATE="Unknown"
                echo "${GREEN}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Battery: ${BATTERY_CHARGE}% - Charge Limit: ${CHARGE_MAX}% - State: $STATE${RESET}" >> "$LOG_FILE"
            else
                echo "Failed to read $BATTERY_PATH" >&2
            fi

            if grep -q '^STARTUP_BATTERYCONTROL=1' "$CONFIG_FILE"; then
                if [[ ! -f "$CONF_TARGET" ]]; then
                    sudo cp "$CONF_SOURCE" "$CONF_TARGET"
                    echo "${GREEN}$(date '+%F %T') - BatteryControl Startup enabled${RESET}" >> "$LOG_FILE"
                fi
            else
                if [[ -f "$CONF_TARGET" ]]; then
                    sudo rm -f "$CONF_TARGET"
                    echo "${RED}$(date '+%F %T') - BatteryControl Startup disabled${RESET}" >> "$LOG_FILE"
                fi
            fi
        fi

        if ! read -r CHARGE < "$BATTERY_PATH"; then
            echo "Failed to read $BATTERY_PATH" >&2
            sleep 5
            continue
        fi

        if ! read -r STATUS < "$STATUS_PATH"; then
            STATUS="Unknown"
        fi

        ACTIVE_PORT=$(detect_active_usbpd_port)
        if [ "$ACTIVE_PORT" != "-1" ]; then
            CHARGER_PATH="/sys/class/power_supply/CROS_USBPD_CHARGER${ACTIVE_PORT}/online"
            if [ -f "$CHARGER_PATH" ]; then
                read -r AC_ON < "$CHARGER_PATH" || AC_ON=0
            else
                AC_ON=0
            fi
        else
            AC_ON=0
        fi

        CHARGE_MIN=$((CHARGE_MAX - 4))

        if [ "$AC_ON" -eq 1 ]; then
            if (( CHARGE >= CHARGE_MAX )); then
                sudo ectool chargecontrol idle >/dev/null 2>&1
            elif (( CHARGE <= CHARGE_MIN )); then
                sudo ectool chargecontrol normal >/dev/null 2>&1
            fi
        else
            sudo ectool chargecontrol normal >/dev/null 2>&1
        fi

        sleep 7
    done
}

stop_monitoring() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            kill "$PID"
            echo "${RED}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - BatteryControl Stopped (PID $PID)${RESET}" | tee -a "$LOG_FILE"
        fi
        rm -f "$PID_FILE"
    fi

    rm -f "$RUN_FLAG"
}

usage() {
    echo "${GREEN}CTRL-C to exit${RESET}"
    while true; do
        data=$(sudo ectool battery 2>/dev/null)
        voltage_mV=$(echo "$data" | awk '/Present voltage/ {print $3}' | tr -d '[:alpha:]')
        current_mA=$(echo "$data" | awk '/Present current/ {print $3}' | tr -d '[:alpha:]')
    
        if [[ -z "$voltage_mV" || -z "$current_mA" ]]; then
            echo "${RED}$(date +'%H:%M:%S') - Error reading battery${RESET}"
            sleep 1
            continue
        fi
    
        voltage=$(echo "scale=3; $voltage_mV / 1000" | bc)
        current=$(echo "scale=3; $current_mA / 1000" | bc)
        power=$(echo "scale=3; $voltage * $current" | bc)
    
        if [[ $(echo "$power < 0" | bc -l) -eq 1 ]]; then
            COLOR="$YELLOW"
        else
            COLOR="$GREEN"
        fi
    
        echo "${COLOR}$(date +'%H:%M:%S'): ${power} W${RESET}"
        sleep 1
    done
}

case "$1" in
    set)
        set_threshold "$2"
        ;;
    start)
        stop_monitoring >/dev/null 2>&1
        LOG_FILE="/var/log/batterycontrol.log"

        if [ -f "$LOG_FILE" ] && [ "$(stat -c%s "$LOG_FILE")" -gt 32768 ]; then
            echo "$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Truncated log file (exceeded 32KB)" > "$LOG_FILE"
        fi


        nohup "$0" __batterycontrol_monitor__ >> "$LOG_FILE" 2>&1 &
        echo "${GREEN}$(printf '%(%Y-%m-%d %H:%M:%S)T\n' -1) - Starting BatteryControl - Output is logged to $LOG_FILE${RESET}" | tee -a "$LOG_FILE"
        ;;
    stop)
        stop_monitoring
        ;;
    ""|status)
        battery_status
        ;;
    startup)
        CONF_SOURCE="$INSTALL_DIR/batterycontrol.conf"
        CONF_TARGET="/etc/init/batterycontrol.conf"

        read -p "Do you want BatteryControl to startup automatically? (y/n): " choice
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            if [ -f "$CONF_SOURCE" ]; then
                echo "Copying batterycontrol.conf to /etc/init/..."
                sudo cp "$CONF_SOURCE" "$CONF_TARGET"
                echo "${GREEN}batterycontrol.conf copied.${RESET}"
            else
                echo "${RED}batterycontrol.conf not found at $CONF_SOURCE${RESET}"
            fi
        else
            echo "BatteryControl will not startup automatically."
            sudo rm -r /etc/init/batterycontrol.conf 2>/dev/null
        fi
        ;;
    usage)
        usage
        ;;
   --h|-h|h|--help|-help|help)
        show_help
        ;;
    __batterycontrol_monitor__)
        start_monitoring_loop
        ;;
    monitor|mon)
        tail -f /var/log/batterycontrol.log
        ;;
    ''|*[!0-9]*)
        echo "Unknown command or value is too low: $1"
        echo "Use '$0 help' to see available commands."
        exit 1
        ;;
    *)
        if [[ "$1" =~ ^[0-9]+$ ]] && (( $1 >= 14 && $1 <= 100 )); then
            set_threshold "$1"
        else
            echo "${RED}Unknown command or value is too low: $1 ${RESET}"
            show_help
            exit 1
        fi
        ;;
esac
